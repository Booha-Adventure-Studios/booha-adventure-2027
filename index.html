
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Booha Adventure 2027</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Bowlby+One&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#000;
      --pink:#ff3bbd;
      --pink2:#ff79d7;
      --text:#ffffff;
      --muted:rgba(255,255,255,.7);
      --safe-top: env(safe-area-inset-top);
      --safe-right: env(safe-area-inset-right);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);
    }

    *{ box-sizing:border-box; }
    html,body{
      height:100%; margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
        "Noto Sans", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
    }

    /* ── App container ── */
    #app{
      position:fixed; inset:0;
      background: var(--bg) url('assets/img/background-1.png') center center / cover no-repeat;
      overflow:hidden;
    }

    /* Subtle dark vignette over the bg so text stays readable */
    #app::before{
      content:'';
      position:absolute; inset:0;
      background: radial-gradient(ellipse at center,
        rgba(0,0,0,.10) 0%,
        rgba(0,0,0,.48) 100%);
      pointer-events:none;
      z-index:0;
    }

    /* ── Rotate overlay ── */
    #rotateOverlay{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding: calc(24px + var(--safe-top)) calc(24px + var(--safe-right))
               calc(24px + var(--safe-bottom)) calc(24px + var(--safe-left));
      text-align:center;
      background:rgba(0,0,0,.92);
      z-index:50;
    }
    #rotateOverlay .card{
      max-width:520px;
      border:1px solid rgba(255,255,255,.18);
      border-radius:22px;
      padding:22px 18px;
    }
    #rotateOverlay h2{ margin:0 0 8px; font-size:22px; letter-spacing:.5px; }
    #rotateOverlay p{ margin:0; color:var(--muted); line-height:1.4; }

    /* ── Scenes ── */
    .scene{ position:absolute; inset:0; display:none; z-index:1; background:transparent; }
    .scene.active{ display:flex; }
    /* Start + video = solid black */
    #startScene{ background:#000; }
    #videoScene{ background:#000; }
    /* Hub = transparent so background-1.png shows through */
    #hubScene{ background:transparent; }

    /* ── START scene ── */
    #startScene{
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:22px;
      padding: calc(24px + var(--safe-top)) calc(24px + var(--safe-right))
               calc(24px + var(--safe-bottom)) calc(24px + var(--safe-left));
      text-align:center;
    }

    /* Ghost + sparkles */
    .ghostOuter{
      position:relative;
      width: min(32vmin, 260px);
      height: min(32vmin, 260px);
      transform: translateZ(0);
    }

    .ghostWrap{
      position:absolute; inset:0;
      width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      pointer-events:none;
      animation: floaty 3.8s ease-in-out infinite;
      filter: drop-shadow(0 14px 28px rgba(0,0,0,.75));
      will-change: transform, opacity;
    }

    .ghostWrap.flyAway{
      animation:none;
      transition:
        transform 1800ms cubic-bezier(.15,.8,.25,1),
        opacity   1600ms ease 200ms;
      transform: translate3d(0,-85vh,0) scale(.7) rotate(-4deg);
      opacity:0;
    }

    @keyframes floaty{
      0%  { transform: translateY(0px); }
      50% { transform: translateY(-14px); }
      100%{ transform: translateY(0px); }
    }

    .sparkleField{
      position:absolute;
      inset:-60px;
      pointer-events:none;
    }

    .sp{
      position:absolute;
      border-radius:50%;
      background:#fff;
      opacity:0;
      animation: sparkleLife var(--dur) ease-in-out var(--delay) infinite;
      width: var(--size); height: var(--size);
      top: var(--y); left: var(--x);
      box-shadow:
        0 0 4px 1px rgba(255,255,255,.9),
        0 0 10px 3px rgba(255,100,220,.6);
    }

    @keyframes sparkleLife{
      0%  { opacity:0;    transform: scale(.4) translateY(0); }
      20% { opacity:1;    transform: scale(1)  translateY(-6px); }
      60% { opacity:.85;  transform: scale(.9) translateY(-14px); }
      100%{ opacity:0;    transform: scale(.3) translateY(-22px); }
    }

    #boohaGhost{
      width:100%; height:100%;
      object-fit:contain;
      user-select:none;
      -webkit-user-drag:none;
    }

    .startText{ text-align:center; }
    .startText .line1{ font-size:16px; letter-spacing:.2px; color:var(--muted); }
    .startText .line2{ font-size:14px; color:rgba(255,255,255,.55); margin-top:6px; }

    /* Start button — single pink glow (not rainbow, just the week cards) */
    .btn{
      appearance:none; border:0;
      border-radius:999px;
      padding:14px 22px;
      font-size:18px; font-weight:900; letter-spacing:.6px;
      cursor:pointer; color:#000;
      background: linear-gradient(180deg, var(--pink2), var(--pink));
      box-shadow:
        0 10px 22px rgba(255,59,189,.28),
        0 0 0 2px rgba(255,59,189,.15),
        0 0 26px rgba(255,59,189,.35);
      transform: translateZ(0);
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: scale(.98); }

    /* ── VIDEO scene ── */
    #videoScene{ align-items:center; justify-content:center; background:#000; }
    #introVideo{ width:100%; height:100%; object-fit:cover; background:#000; }

    /* ── Fade layer ── */
    #fade{
      position:absolute; inset:0;
      background:#000; opacity:0;
      pointer-events:none;
      transition: opacity 520ms ease;
      z-index:40;
    }
    #fade.on{ opacity:1; }

    /* ══════════════════════════════════════════
       HUB SCENE
    ══════════════════════════════════════════ */
    #hubScene{
      padding: calc(22px + var(--safe-top)) calc(22px + var(--safe-right))
               calc(22px + var(--safe-bottom)) calc(22px + var(--safe-left));
      align-items:center;
      justify-content:center;
    }

    .hub{
      width: min(1000px, 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:18px;
    }

    /* Hub title */
    .hubHeading{
      text-align:center;
      font-family: 'Bowlby One', system-ui, sans-serif;
      font-size: clamp(26px, 4vw, 52px);
      font-weight:400; /* Bowlby One is already heavy */
      letter-spacing:3px;
      color:#fff;
      text-shadow:
        0 0 32px rgba(255,140,255,.65),
        0 0 80px rgba(255,80,200,.3),
        0 2px 8px rgba(0,0,0,.9);
    }

    /* 3-card row */
    .hubRow{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:16px;
      width:100%;
    }

    /* ── Glassy / frosted week card ── */
    .weekCard{
      position:relative;
      border-radius:26px;
      overflow:hidden;          /* clips shimmer pseudo-element */
      padding:20px 18px 16px;
      min-height:170px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      text-align:center;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transform: translateZ(0);
      transition: transform 220ms ease, box-shadow 220ms ease;

      /* Frosted glass base */
      background: rgba(255,255,255,.09);
      backdrop-filter: blur(18px) saturate(160%);
      -webkit-backdrop-filter: blur(18px) saturate(160%);

      /* Rainbow-cycling border via box-shadow — each card has its own hue offset */
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.22),
        0 8px 32px rgba(0,0,0,.35),
        0 0 0 2px hsl(var(--hue,0deg) 90% 65% / .7),
        0 0 22px 4px hsl(var(--hue,0deg) 90% 65% / .35);

      animation: rainbowHue var(--rainbow-speed, 5s) linear infinite;
      animation-delay: var(--rainbow-offset, 0s);
    }

    /* Rainbow hue rotation on the CSS custom property */
    @property --hue {
      syntax: '<angle>';
      inherits: false;
      initial-value: 0deg;
    }

    @keyframes rainbowHue{
      from{ --hue: 0deg; }
      to  { --hue: 360deg; }
    }

    /* Each card offset so they're never the same color */
    .weekCard:nth-child(1){ --rainbow-offset: 0s;    --rainbow-speed: 5s; }
    .weekCard:nth-child(2){ --rainbow-offset: -1.67s; --rainbow-speed: 5s; }
    .weekCard:nth-child(3){ --rainbow-offset: -3.33s; --rainbow-speed: 5s; }

    /* Shimmer sweep pseudo-element */
    .weekCard::before{
      content:'';
      position:absolute;
      inset:0;
      background: linear-gradient(
        120deg,
        transparent 30%,
        rgba(255,255,255,.18) 50%,
        transparent 70%
      );
      transform: translateX(-100%);
      animation: shimmerSweep 3.8s ease-in-out infinite;
      animation-delay: var(--shimmer-offset, 0s);
      pointer-events:none;
    }
    .weekCard:nth-child(1)::before{ --shimmer-offset: 0s; }
    .weekCard:nth-child(2)::before{ --shimmer-offset: 1.2s; }
    .weekCard:nth-child(3)::before{ --shimmer-offset: 2.4s; }

    @keyframes shimmerSweep{
      0%  { transform: translateX(-100%) skewX(-12deg); opacity:0; }
      20% { opacity:1; }
      60% { transform: translateX(200%)  skewX(-12deg); opacity:0; }
      100%{ transform: translateX(200%)  skewX(-12deg); opacity:0; }
    }

    .weekCard:hover{
      transform: translateY(-4px) scale(1.02);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.32),
        0 16px 40px rgba(0,0,0,.45),
        0 0 0 2px hsl(var(--hue,0deg) 90% 70% / .9),
        0 0 36px 8px hsl(var(--hue,0deg) 90% 65% / .5);
    }
    .weekCard:active{ transform: scale(.99); }

    /* Card internals — all centered */
    .weekTag{
      font-weight:1000; letter-spacing:1.5px; font-size:13px;
      text-transform:uppercase;
      color: rgba(255,255,255,.6);
    }
    .weekTag span{ color:rgba(255,255,255,.9); margin-left:4px; }

    .weekTitle{
      font-size: clamp(16px, 2.2vw, 22px);
      font-weight:1000; letter-spacing:.4px;
      color:#fff;
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
      margin-top:8px;
    }

    .weekDates{
      font-size:13px;
      color:rgba(255,255,255,.65);
      margin-top:5px;
      line-height:1.4;
    }

    .weekHint{
      margin-top:14px;
      font-size:11px;
      letter-spacing:1.5px;
      color:rgba(255,255,255,.45);
      text-transform:uppercase;
    }

    /* Hub bottom */
    .hubBottom{
      display:flex;
      justify-content:center;
      padding-top:2px;
    }

    .btnSmall{ padding:12px 20px; font-size:15px; }

    /* ── Picker overlay ── */
    .picker{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding: calc(18px + var(--safe-top)) calc(18px + var(--safe-right))
               calc(18px + var(--safe-bottom)) calc(18px + var(--safe-left));
      background:
        radial-gradient(ellipse at center,
          rgba(0,0,0,.55) 0%,
          rgba(0,0,0,.82) 65%,
          rgba(0,0,0,.92) 100%);
      backdrop-filter: blur(10px) saturate(130%);
      -webkit-backdrop-filter: blur(10px) saturate(130%);
      z-index:60;
    }
    .picker.show{ display:flex; }

    /* Panel matches hub card aesthetic */
    .pickerPanel{
      position:relative;
      width: min(920px,100%);
      border-radius:30px;
      overflow:hidden;
      padding:18px 18px 16px;

      background: rgba(255,255,255,.09);
      backdrop-filter: blur(22px) saturate(160%);
      -webkit-backdrop-filter: blur(22px) saturate(160%);

      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.22),
        0 26px 70px rgba(0,0,0,.75),
        0 0 0 2px hsl(var(--hue,0deg) 90% 65% / .75),
        0 0 34px 8px hsl(var(--hue,0deg) 90% 65% / .35);

      animation: rainbowHue 5s linear infinite;
    }

    /* Shimmer sweep across the panel */
    .pickerPanel::before{
      content:'';
      position:absolute; inset:0;
      background: linear-gradient(
        120deg,
        transparent 35%,
        rgba(255,255,255,.16) 50%,
        transparent 65%
      );
      transform: translateX(-110%) skewX(-12deg);
      animation: shimmerSweep 4.2s ease-in-out infinite;
      pointer-events:none;
    }

    .pickerTop{
      display:flex; align-items:center;
      justify-content:space-between; gap:10px;
      position:relative; z-index:1;
    }

    .pickerTitle{
      font-family: 'Bowlby One', system-ui, sans-serif;
      font-size: clamp(18px, 2.4vw, 24px);
      letter-spacing:2px;
      text-align:center; flex:1;
      text-shadow:
        0 0 24px rgba(255,140,255,.55),
        0 2px 10px rgba(0,0,0,.85);
    }

    .ghostBtn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      color:rgba(255,255,255,.92);
      border-radius:999px;
      padding:10px 16px;
      font-weight:1000; letter-spacing:.4px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.10),
        0 10px 22px rgba(0,0,0,.35);
    }
    .ghostBtn:hover{ background: rgba(255,255,255,.10); }
    .ghostBtn:active{ transform:scale(.99); }

    .pickerSub{
      margin-top:10px;
      color:rgba(255,255,255,.72);
      font-size:14px; text-align:center;
      position:relative; z-index:1;
    }

    .pickerSub2{
      margin-top:6px;
      font-size:12px; letter-spacing:1.4px;
      color:rgba(255,255,255,.45);
      text-transform:uppercase; text-align:center;
      position:relative; z-index:1;
    }

    .pickerGrid{
      display:grid;
      grid-template-columns: repeat(3,minmax(0,1fr));
      gap:12px; margin-top:16px;
      position:relative; z-index:1;
    }

    /* Tile redesign */
    .pickTile{
      appearance:none;
      border:0;
      border-radius:22px;
      padding:18px 16px 16px;
      cursor:pointer;
      text-align:left;
      color:#fff;

      background: rgba(0,0,0,.16);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.18),
        0 18px 30px rgba(0,0,0,.35),
        0 0 0 2px hsl(var(--tileHue, 210deg) 90% 65% / .55),
        0 0 26px 6px hsl(var(--tileHue, 210deg) 90% 65% / .22);

      transition: transform 160ms ease, box-shadow 200ms ease, background 200ms ease;
      -webkit-tap-highlight-color: transparent;
    }

    .pickTile:hover{
      transform: translateY(-3px);
      background: rgba(255,255,255,.08);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.28),
        0 24px 40px rgba(0,0,0,.45),
        0 0 0 2px hsl(var(--tileHue, 210deg) 95% 70% / .75),
        0 0 36px 10px hsl(var(--tileHue, 210deg) 90% 65% / .32);
    }
    .pickTile:active{ transform: translateY(-1px) scale(.99); }

    /* Each tile its own hue */
    .pickTile[data-curr="preboo"]      { --tileHue: 315deg; }
    .pickTile[data-curr="booriculum"]  { --tileHue: 190deg; }
    .pickTile[data-curr="boocontinuum"]{ --tileHue: 120deg; }

    /* Tile layout */
    .tileTop{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .tileIcon{
      flex-shrink:0;
      width:60px; height:60px;
      border-radius:18px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.08);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.18),
        0 10px 20px rgba(0,0,0,.35);
    }

    .tileIcon img{
      width:70%; height:70%;
      object-fit:contain;
      pointer-events:none;
      user-select:none;
      -webkit-user-drag:none;
      filter:
        drop-shadow(0 0 10px rgba(255,255,255,.4))
        drop-shadow(0 0 20px rgba(255,255,255,.2));
      transition: transform 200ms ease;
    }
    .pickTile:hover .tileIcon img{ transform: scale(1.10); }

    .tileName{
      font-size:18px; font-weight:1000;
      letter-spacing:.3px; line-height:1.1;
    }

    .tileJp{
      display:block;
      margin-top:5px;
      font-size:13px;
      color:rgba(255,255,255,.70);
    }

    .tileHint{
      margin-top:12px;
      font-size:11px; letter-spacing:1.6px;
      color:rgba(255,255,255,.45);
      text-transform:uppercase;
    }

    .pickerNote{
      margin-top:14px;
      font-size:12px;
      color:rgba(255,255,255,.50);
      text-align:center;
      position:relative; z-index:1;
    }

    /* ── Responsive ── */
    @media (max-width:860px){
      .hubRow{ grid-template-columns:1fr; }
      .weekCard{ min-height:130px; }
      .pickerGrid{ grid-template-columns:1fr; }
      .tileName{ font-size:16px; }
      .tileIcon{ width:50px; height:50px; }
    }

    @media (prefers-reduced-motion: reduce){
      .ghostWrap{ animation:none; }
      #fade{ transition:none; }
      .weekCard{ animation:none; }
      .weekCard::before{ animation:none; }
    }
  </style>
</head>
<body>
<div id="app">

  <div id="rotateOverlay" aria-hidden="true">
    <div class="card">
      <h2>Rotate to Landscape</h2>
      <p>Please turn your device sideways for Booha Adventure.</p>
    </div>
  </div>

  <!-- ── START ── -->
  <section id="startScene" class="scene active" aria-label="Start">
    <div class="ghostOuter">
      <div class="sparkleField" aria-hidden="true"></div>
      <div class="ghostWrap" aria-hidden="true">
        <img id="boohaGhost" src="assets/img/booha_ghost.png" alt="Booha" />
      </div>
    </div>

    <button id="startBtn" class="btn" type="button">スタート</button>
  </section>

  <!-- ── VIDEO ── -->
  <section id="videoScene" class="scene" aria-label="Intro video">
    <video id="introVideo" preload="auto" playsinline webkit-playsinline>
      <source src="assets/video/intro.mp4" type="video/mp4" />
    </video>
  </section>

  <!-- ── HUB ── -->
  <section id="hubScene" class="scene" aria-label="Week Hub">
    <div class="hub">
      <div class="hubHeading">BOOHA ADVENTURE</div>

      <div class="hubRow" id="weekCards">
        <!-- injected by JS -->
      </div>

      <div class="hubBottom">
        <button id="mazeBtn" class="btn btnSmall" type="button">めいろへ（Maze）</button>
      </div>
    </div>
  </section>

  <!-- ── Curriculum picker ── -->
  <div id="picker" class="picker" aria-hidden="true">
    <div class="pickerPanel" role="dialog" aria-modal="true" aria-label="Choose Curriculum">
      <div class="pickerTop">
        <div style="width:70px"></div>
        <div class="pickerTitle" id="pickerTitle">THIS WEEK（今週）</div>
        <button id="pickerClose" class="ghostBtn" type="button" aria-label="Back">戻る</button>
      </div>

      <div class="pickerSub" id="pickerDates">Jan 3 – Jan 9（1月3日–1月9日）</div>
      <div class="pickerSub2">Choose your curriculum</div>

      <div class="pickerGrid">

        <button class="pickTile" type="button" data-curr="preboo">
          <div class="tileTop">
            <div class="tileIcon">
              <img src="assets/img/pre-boo.png" alt="Pre-Boo" />
            </div>
            <div>
              <div class="tileName">Pre-Boo</div>
              <span class="tileJp">プレブー</span>
            </div>
          </div>
          <div class="tileHint">Tap to enter →</div>
        </button>

        <button class="pickTile" type="button" data-curr="booriculum">
          <div class="tileTop">
            <div class="tileIcon">
              <img src="assets/img/boo-tree.png" alt="Boo-riculum" />
            </div>
            <div>
              <div class="tileName">Boo-riculum</div>
              <span class="tileJp">ブーリキュラム</span>
            </div>
          </div>
          <div class="tileHint">Tap to enter →</div>
        </button>

        <button class="pickTile" type="button" data-curr="boocontinuum">
          <div class="tileTop">
            <div class="tileIcon">
              <img src="assets/img/cont-tree.png" alt="Boo-continuum" />
            </div>
            <div>
              <div class="tileName">Boo-continuum</div>
              <span class="tileJp">ブーコンティニューム</span>
            </div>
          </div>
          <div class="tileHint">Tap to enter →</div>
        </button>

      </div>

      <div class="pickerNote">※ ここはプレースホルダーです（後でリンクします）</div>
    </div>
  </div>

  <div id="fade" aria-hidden="true"></div>
</div>

<script>
  /* ── Element refs ── */
  const startScene    = document.getElementById('startScene');
  const videoScene    = document.getElementById('videoScene');
  const hubScene      = document.getElementById('hubScene');
  const startBtn      = document.getElementById('startBtn');
  const introVideo    = document.getElementById('introVideo');
  const fade          = document.getElementById('fade');
  const rotateOverlay = document.getElementById('rotateOverlay');
  const ghostWrap     = document.querySelector('.ghostWrap');
  const sparkleField  = document.querySelector('.sparkleField');

  /* ── Scene helpers ── */
  function showScene(el){
    [startScene, videoScene, hubScene].forEach(s => s.classList.remove('active'));
    el.classList.add('active');
  }
  function fadeToBlack(on = true){
    fade.classList.toggle('on', !!on);
  }

  /* ── Orientation overlay ── */
  function updateOrientationOverlay(){
    const portrait = window.matchMedia('(orientation: portrait)').matches;
    const small    = Math.min(window.innerWidth, window.innerHeight) < 700;
    const show     = small && portrait;
    rotateOverlay.style.display = show ? 'flex' : 'none';
    rotateOverlay.setAttribute('aria-hidden', show ? 'false' : 'true');
  }
  window.addEventListener('resize', updateOrientationOverlay, { passive: true });
  updateOrientationOverlay();

  /* ── Sparkles ── */
  (function initSparkles(){
    if (!sparkleField) return;
    const COUNT = 32;
    sparkleField.innerHTML = '';
    for (let i = 0; i < COUNT; i++){
      const sp = document.createElement('div');
      sp.className = 'sp';
      const angle  = (i / COUNT) * Math.PI * 2;
      const radius = 28 + Math.random() * 22;
      const cx     = 50 + Math.cos(angle) * radius;
      const cy     = 50 + Math.sin(angle) * radius;
      const size   = 2 + Math.random() * 3;
      const dur    = 1.4 + Math.random() * 2.0;
      const delay  = -(Math.random() * dur);
      sp.style.cssText = `
        --size:${size}px; --x:${cx}%; --y:${cy}%;
        --dur:${dur}s; --delay:${delay}s;
      `;
      sparkleField.appendChild(sp);
    }
  })();

  /* ── Hardcoded week data (launch = January Week 1) ── */
  /*
    LAST WEEK  = December Week 4  (Dec 20 – Dec 26)
    THIS WEEK  = January Week 1   (Jan 3  – Jan 9)
    NEXT WEEK  = January Week 2   (Jan 10 – Jan 16)

    The date math still runs so the hub stays accurate as real weeks pass,
    but the special pre-cycle Dec Week 4 is always resolvable.
  */

  const MONTH_NAME = {
    jan:'January', feb:'February', mar:'March', apr:'April',
    may:'May',     jun:'June',     jul:'July',  aug:'August',
    sep:'September', oct:'October', nov:'November', dec:'December'
  };

  // ── DEV DATE OVERRIDE ──
  // Set to any date string to simulate that day. Set to null before launch.
  const DEV_DATE = '2027-01-03';

  function tokyoTodayYMD(){
    if (DEV_DATE){
      const [y,m,d] = DEV_DATE.split('-').map(Number);
      return {y, m, d};
    }
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone:'Asia/Tokyo',
      year:'numeric', month:'2-digit', day:'2-digit'
    }).formatToParts(new Date());
    const map = Object.fromEntries(
      parts.filter(p => p.type !== 'literal').map(p => [p.type, p.value])
    );
    return { y:+map.year, m:+map.month, d:+map.day };
  }

  function ymdToMs(y,m,d){ return Date.UTC(y,m-1,d); }

  function parseYMD(str){
    const [y,m,d] = str.split('-').map(Number);
    return {y,m,d};
  }

  function addDays(ymd,n){
    const ms = ymdToMs(ymd.y,ymd.m,ymd.d) + n*86400000;
    const dt = new Date(ms);
    return {y:dt.getUTCFullYear(), m:dt.getUTCMonth()+1, d:dt.getUTCDate()};
  }

  function fmtRange(s,e){
    const MO=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const en = ymd => `${MO[ymd.m-1]} ${ymd.d}`;
    const jp = ymd => `${ymd.m}月${ymd.d}日`;
    return `${en(s)} – ${en(e)}（${jp(s)}–${jp(e)}）`;
  }

  function labelFromWeekId(id){
    if (!id) return '—';
    if (id === 'dec_w4_pre') return 'December Week 4';
    // Structured IDs from year.json e.g. "2027_01_jan_w1"
    if (id.includes('_') && id.split('_').length >= 4){
      const p = id.split('_');
      const mon = p[2];
      const wn  = (p[3]||'w1').replace('w','');
      return `${MONTH_NAME[mon]||mon} Week ${wn}`;
    }
    // Generic fallback e.g. "week_1" → "Week 1"
    if (id.startsWith('week_')) return `Week ${id.replace('week_','')}`;
    return id;
  }

  function buildCard({tagEn, tagJp, weekId, title, rangeText, hint}){
    const div = document.createElement('div');
    div.className = 'weekCard';
    div.dataset.weekId = weekId || '';
    div.innerHTML = `
      <div>
        <div class="weekTag">${tagEn}<span>（${tagJp}）</span></div>
        <div class="weekTitle">${title}</div>
        <div class="weekDates">${rangeText}</div>
      </div>
      <div class="weekHint">${hint||'TAP TO OPEN'}</div>
    `;
    return div;
  }

  // ── Picker: bound once, never duplicated ──
  const picker      = document.getElementById('picker');
  const pickerTitle = document.getElementById('pickerTitle');
  const pickerDates = document.getElementById('pickerDates');
  const pickerClose = document.getElementById('pickerClose');
  const mazeBtn     = document.getElementById('mazeBtn');

  let currentPickerWeekId = '';

  function openPicker(tagEn, tagJp, dates, weekId){
    if (!weekId) return;
    currentPickerWeekId = weekId;
    pickerTitle.textContent = `${tagEn}（${tagJp}）`;
    pickerDates.textContent = dates;
    picker.classList.add('show');
    picker.setAttribute('aria-hidden','false');
  }

  function closePicker(){
    currentPickerWeekId = '';
    picker.classList.remove('show');
    picker.setAttribute('aria-hidden','true');
  }

  pickerClose.addEventListener('click', closePicker);
  picker.addEventListener('click', e => { if (e.target === picker) closePicker(); });

  document.querySelectorAll('.pickTile').forEach(btn => {
    btn.addEventListener('click', () => {
      const curr = btn.dataset.curr;
      alert(`PLACEHOLDER\nweek: ${currentPickerWeekId}\ncurriculum: ${curr}`);
    });
  });

 if (mazeBtn){
  mazeBtn.addEventListener('click', () => {
    fadeToBlack(true);
    setTimeout(() => {
      window.location.href = 'maze.html';
    }, 520); // match your FADE_MS
  });
}
  async function renderHub(){
    const weekCards = document.getElementById('weekCards');
    weekCards.innerHTML = '';

    // ── Try to load year.json; fall back to hardcoded Jan Week 1 launch data ──
    let year = null;
    try {
      const res = await fetch(`data/year.json?v=${Date.now()}`);
      if (res.ok) year = await res.json();
    } catch(e){ /* no json available, use fallback */ }

    // Cycle start = Jan 3 2027 (Sunday-based 48-week cycle)
    const CYCLE_START_STR = (year && year.cycleStart) || '2027-01-03';
    const cycleStart   = parseYMD(CYCLE_START_STR);
    const cycleStartMs = ymdToMs(cycleStart.y, cycleStart.m, cycleStart.d);
    const cycleLength  = (year && year.cycleLength) || 48;
    const weeks        = (year && year.weeks)       || [];

    const today   = tokyoTodayYMD();
    const todayMs = ymdToMs(today.y, today.m, today.d);
    const diffDays = Math.floor((todayMs - cycleStartMs) / 86400000);

    // ── THIS WEEK ──
    let thisIdx, thisWeekId, thisStart;

    if (diffDays < 0){
      // Before cycle start → we're in December Week 4 (pre-launch)
      thisIdx    = -1;
      thisWeekId = (year && year.preStartWeek) || 'dec_w4_pre';
      thisStart  = addDays(cycleStart, -14);
    } else {
      thisIdx    = Math.floor(diffDays / 7) % cycleLength;
      thisWeekId = weeks[thisIdx] || `week_${thisIdx+1}`;
      thisStart  = addDays(cycleStart, thisIdx * 7);
    }
    const thisEnd = addDays(thisStart, 6);

    // ── LAST WEEK ──
    let lastWeekId=null, lastStart=null, lastEnd=null;
    if (thisIdx === -1){
      lastWeekId = null;
    } else if (thisIdx === 0){
      // January Week 1 is always first — last week is always December Week 4
      lastWeekId = 'dec_w4_pre';
      lastStart  = {y:2026, m:12, d:20};
      lastEnd    = {y:2026, m:12, d:26};
    } else {
      const lIdx = (thisIdx - 1 + cycleLength) % cycleLength;
      lastWeekId = weeks[lIdx] || `week_${lIdx+1}`;
      lastStart  = addDays(cycleStart, lIdx * 7);
      lastEnd    = addDays(lastStart, 6);
    }

    // ── NEXT WEEK ──
    let nextWeekId=null, nextStart=null, nextEnd=null;
    if (thisIdx === -1){
      nextWeekId = weeks[0] || 'week_1';
      nextStart  = cycleStart;
      nextEnd    = addDays(nextStart, 6);
    } else {
      const nIdx = (thisIdx + 1) % cycleLength;
      nextWeekId = weeks[nIdx] || `week_${nIdx+1}`;
      nextStart  = addDays(cycleStart, nIdx * 7);
      nextEnd    = addDays(nextStart, 6);
    }

    // ── Render 3 cards ──
    if (lastWeekId){
      weekCards.appendChild(buildCard({
        tagEn:'LAST WEEK', tagJp:'先週',
        weekId:    lastWeekId,
        title:     labelFromWeekId(lastWeekId),
        rangeText: fmtRange(lastStart, lastEnd)
      }));
    } else {
      weekCards.appendChild(buildCard({
        tagEn:'LAST WEEK', tagJp:'先週',
        weekId:'', title:'—', rangeText:'—', hint:'LOCKED'
      }));
    }

    weekCards.appendChild(buildCard({
      tagEn:'THIS WEEK', tagJp:'今週',
      weekId:    thisWeekId,
      title:     labelFromWeekId(thisWeekId),
      rangeText: fmtRange(thisStart, thisEnd)
    }));

    weekCards.appendChild(buildCard({
      tagEn:'NEXT WEEK', tagJp:'来週',
      weekId:    nextWeekId||'',
      title:     nextWeekId ? labelFromWeekId(nextWeekId) : '—',
      rangeText: nextWeekId ? fmtRange(nextStart, nextEnd) : '—',
      hint:      nextWeekId ? 'TAP TO OPEN' : 'LOCKED'
    }));

    // ── Wire card clicks (safe to re-run; cards are replaced each time) ──
    weekCards.querySelectorAll('.weekCard').forEach(card => {
      card.addEventListener('click', () => {
        const wid   = card.dataset.weekId;
        if (!wid) return;
        const dates = card.querySelector('.weekDates')?.textContent || '';
        const tag   = card.querySelector('.weekTag')?.textContent   || '';
        if      (tag.includes('LAST WEEK')) openPicker('LAST WEEK','先週', dates, wid);
        else if (tag.includes('THIS WEEK')) openPicker('THIS WEEK','今週', dates, wid);
        else                                openPicker('NEXT WEEK','来週', dates, wid);
      });
    });
  }

  /* ── Start flow ── */
  let started = false;

  async function startIntro(){
    if (started) return;
    started = true;

    ghostWrap.classList.add('flyAway');
    fadeToBlack(true);

    await new Promise(r => setTimeout(r, 900));

    showScene(videoScene);
    try { introVideo.currentTime = 0; } catch(e){}
    setTimeout(() => fadeToBlack(false), 60);

    try {
      await introVideo.play();
    } catch(err){
      started   = false;
      fadingOut = false;  // reset so goToHub can fire correctly later
      ghostWrap.classList.remove('flyAway');
      showScene(startScene);
      fadeToBlack(false);
      alert('もう一度「スタート」をタップしてください。');
    }
  }

  startBtn.addEventListener('click', startIntro);

  /* ── Video → Hub transition ── */
  const FADE_MS = 520;
  let fadingOut = false;

  async function goToHub(){
    if (fadingOut) return;
    fadingOut = true;
    fadeToBlack(true);
    setTimeout(async () => {
      try { introVideo.pause(); } catch(e){}
      showScene(hubScene);
      try { await renderHub(); } catch(e){ console.error(e); }
      requestAnimationFrame(() => requestAnimationFrame(() => fadeToBlack(false)));
    }, FADE_MS);
  }

  introVideo.addEventListener('timeupdate', () => {
    const d = introVideo.duration;
    if (!isFinite(d) || d <= 0) return;
    if (d - introVideo.currentTime <= 0.85) goToHub();  // bumped from 0.65 for iOS
  });
  introVideo.addEventListener('ended', goToHub);

  introVideo.addEventListener('error', () => {
    fadeToBlack(true);
    setTimeout(async () => {
      showScene(hubScene);
      try { await renderHub(); } catch(e){ console.error(e); }
      requestAnimationFrame(() => requestAnimationFrame(() => fadeToBlack(false)));
    }, FADE_MS);
  });

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) try { introVideo.pause(); } catch(e){}
  });
</script>
</body>
</html>
